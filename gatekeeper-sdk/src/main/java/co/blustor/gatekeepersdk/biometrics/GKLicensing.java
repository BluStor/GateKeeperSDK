package co.blustor.gatekeepersdk.biometrics;

import android.util.Log;

import java.io.IOException;

import co.blustor.gatekeepersdk.biometrics.licensing.FetchExistingLicense;
import co.blustor.gatekeepersdk.biometrics.licensing.GenerateActiveLicense;
import co.blustor.gatekeepersdk.biometrics.licensing.LicenseFileExtensions;
import co.blustor.gatekeepersdk.data.GKFile;
import co.blustor.gatekeepersdk.services.GKFileActions;
import co.blustor.gatekeepersdk.utils.GKFileUtils;

/**
 * GKLicensing is responsible for obtaining the licenses necessary for GateKeeper biometrics.
 */
public class GKLicensing {
    private static final String TAG = GKLicensing.class.getCanonicalName();

    public final static String LICENSE_BASE_FILE_NAME = "license";
    public final static String LICENSE_FILE_NAME = "license" + "." + LicenseFileExtensions.LICENSE;
    public final static String LICENSE_SERIAL_FILE_NAME = "license" + "." + LicenseFileExtensions.SERIAL_NUMBER;

    /**
     * The {@code String} license IDs needed by GateKeeper biometrics.
     */
    public static final String[] LICENSES = {
            "Biometrics.FaceExtraction",
            "Biometrics.FaceDetection",
            "Devices.Cameras"
    };

    protected final String mLicenseSubDir;
    private final GKFileActions mFileActions;
    private final BiometricLicenseManager mLicenseManager;
    protected FetchExistingLicense mFetchExistingLicense;
    protected GenerateActiveLicense mGenerateActiveLicense;

    /**
     * Create a {@code GKLicensing} with the given host address and port.
     *
     * @param licenseSubDir  the directory on the card to look for activated licenses
     * @param fileActions    {@code GKFileActions}
     * @param licenseManager a BiometricLicenseManager which wraps the NLicense class
     * @since 0.11.0
     */
    public GKLicensing(String licenseSubDir, GKFileActions fileActions, BiometricLicenseManager licenseManager) {
        mLicenseSubDir = parseLicenseSubDir(licenseSubDir);
        mFileActions = fileActions;
        mLicenseManager = licenseManager;
    }

    /**
     * Checks the specified subdirectory for an activated license and validates it
     * If no activated license is found, attempt to activate one
     *
     * @return a {@code GKLicenseValidationResult} indicating success or a reason for failure
     * @since 0.11.0
     */
    public GKLicenseValidationResult obtainLicenses() {
        Log.d(TAG, "obtainLicenses() Get the license file");
        try {
            //String license = getLicense();
            String license = ":000000047C262C17FE2F44ED792505259FB5AB31C8766C4F902A096D056D161ACF263EA12F95A0C6DDB2A5DEDD99B22DF734B7367238BD2DDFE9DFEB41F915ADE0BCF1350838CA728441777C6A2885468618DE10D0B774A1BBFC01A3F206A48C8CC602BA55B521B6B63ABBEBDBAD42CA38AE572DA427D5EE573E6D5936C4F6A226B9F18E2283D46B6A5EA797D44CE4029DB077D4A150C6F1B19FAA416B879C622576440AE0DEE9C1AE70F37559BA5EF7B7CE6DDDD7BBC97C719074D845FDBCF155ECCD38476973074139276F94A020FA8770A3CFEB8584C4518CD9EB1C7868EE50DD374464AB627AEE5E79A312F78DB36E89D26AFF5BBEDC4AD106D2CCD6409A3AE14C806A892A7C115A5B5FEE8D0059E33811A3828A53D78BE0CE6BB17010B0266ABBD8FBA7D462D947098BC785A3A06361AFA437466E1437FAB9FD506D28ACB20732684A1E3552D67C6F81F2D70E8D39423DFD330EF95E1D44A233F5E93ADA9718C225D38DC6B664B31A4FE7A83DD9DF7EF7A283B891AA2D3540E1441E209B6230F7A8613F0A27FF41C6E6011AE0ED6ED9A4D27E5D34C3A0487F3D8F361BCD8B5106B5BC005113ABFDEF6C5A15288694A4C0579257557EF5EF56C51694DADDE4E6BEB009D37FB1FC9E9664D176954283CA4331996793B6C40A0E3C994BE62C0F34C4CAD979941601EE3BF4AE237CE8A8AED13EDE8101FDE65EF7F344899ACAA82C1E72228E430EB89E5F9966FEE8F73E4ED1411ACC77E66515585612705D3820AA2DBCEC06986D4F840F6D208F9D7B79D50A51BA47E9CAF0FAE1172BEA657AF0DB2370CFD88DA3CB66618A20355EE64B702AEB0E526E64A32ACD102167E470EEAFC897C746A54FC3E93F83A77C13DED09D656F7F37CD3086B34F46ABFFDE141D34B3804244CB2D143A3C6E200005E91AD3817F8F0A442E922AFCFC7023FF6B617736AFC3BD9DBEC4D3BAFEDB524DDE9716F9F479BBEE3B2542F618113CE591C232EC81CE084DB8FD1653E7DD7A47F2E30478B36F14F759DF0A01F60BFC1C2DFD8C9F7357353F89D7DCADA1C680C02C783A1531CA826A692FD60FD399A7371B7CA54D6300A26619D0F51BCB544812D4100BB8C1D8666661EF601A61BCA1D5B44226F7E011123101AED61B597C5C66062F5555E233F547E953B3738A84499EBEC646654938EE2D1DE968B3846ECB10D8B8F6D3D516E611C8FA2A44A86A42506267397D71B3DE5CB5AB43D9BD232227310588DC7490B89033F952C8D1C9E4BF3A00A2020A3A48890DA9136B0FB053C3E30CACABB37691D7BEAB31B6BC15CBD843E4B501BD0FFC693060498DA6F504DCE07E5F39BAB84402F9C499ECD4C7F73FD0ABB1B6B3C6931B7B2072EA890AA441072542518FA70753150BAA08C81C8DA4D0DA7DE2C0C2C058A22438AFE9DB2D7683F0DFF4082DE75BD2884FA2FF445EE3D59FD26C3BED1884A682458FF405AB877B21916881F4B065521F0DAC9A29929B6E64F3AC651C81E2D688EB3936217A1CEFD3A21BD5729AA1A54E6D62E0CB015B081A15887F1E830D15773768961315E3CEBE4F2E13CD255A31F4A9C0F8ED659D997325BBE8C3D6F439B365D1B04A399F23C96D79976541FA3BB8C482A82C2FBE4CCD9ED9DE20BAFF33E91ECA1C49060CF9739CF275B2767FBC37815293C2DC3651FB495183A6D5D4C0D3D9039B14975C782268C0122BDAB159DADC6B85EAA19DE3994264BC1609AA5FC3BF6A5909FC719B55F83C797F889EC5F4F7AD5EC8D2445FAC04EE636ACE132D1CF4330D5A6EC94265C8617EF948D9E71A379145A456BC2A4802CCB57434CA5893436588B9D75DDEBD69323D57FA9C23E9CB3D88C34B3180380C7EC7488EE78F120832C790B77B62525889E5934F5CBFBA5AE7FCAA42EF569C216E8FCF3587E197C29F796DB4913E46491BC45FF83443A6603778A91119F178FA31EE239DE94B5BE79A7EEA0EB3299EFC41A5DAE4C7292E5F6F2CE188D5E77EB77B5A6124EA10E32659F31BFC6B56BD2C14409FE40AF2B92E31EC2D449894F49684E8351E18F50B411632936B55BDF5197B8882C81744D3135F1A344F48316B2F71CDB78A244C6BA0559DBD6330E48B0A3195882E1C35BF8EC736A3680BA27246F60D0ED98E4D32DFD7D9F39F05F3862FC653E695649418D773DDC25BDAD3D8E3C2247157C30A1AE56B0B3FC057339F59EAD2F9C4EF8DCACEA44F2A75D642D9879F2F82667FC05CBF9B5DAB74851248A9AAC3C9C09D5C5972A20766870DD555E08CE2478FB85B3ECA131C65C9DFFDF72D558AC0C7C1044B3471702BD0ACFFF46430C9A99E8A185EFE217D765C4258927C26355B3639D4CB7E716BDC06F7C5D6713ADE78C3EAB3700EFC4834EA8DD63951876D7640E26CF7021C519893FA35CFD5A477AAFA193850A86BB67C0CB6BB94FBFC91EA672AF0E8A2BCFC12BCC0D9E3790CBD524C780508876B5DB2EAE67E209E4F478CF01BCBBCFEAEE4FA0EB28A9489966ABE54320CFAB95819E91145E03A6EDD3814626FFE3943158C4A9C7203A320BE89532FCDF9869B1DB6921763E57BE8EE158565F0CACFC413A18BD978F7403BB0B61D74F46398FCD4819D348FB81356864FD8C7446CD4AC3E9A52477ADCC6529CDD76EAB55F2FC4D0C917A73BCD7537299E5E3C1021F1F0234A9C9E18C4466E22ED45612A17E7B1FBA5EFF60988B4910D7D67EFAD5780FAC94A6CD304A8DCC32D681DE1568D911CA4F09E77E55F47B25CD2F69C787BA5283DE574B31FC8DD9CBB23CCD67CA99511A59CB095A45E7CD59456088D48275C885D0018E0C19047C2B991B4423798CEEEF4306E8448F7DB0E95B31685C3356D00C0F251776C00C416CB6ED21C11959B443C4EDAAC3C078178AB5F1D65D236F80F3A13E10D5A794A0745DEB718A18425CA195AC41676FDF827AE7B32E33BB25D46AAE22A5B6611E31DDF911CD525199382F92E4155EF9545812130FEDFCC9154C37E52AD8507433E7CCAB0249DA5EDBAF6539651936302E23F4D583F7AD604F37217F5120C279977DD4755CCFF8C699BCE6B6E48F0EBC780F8A7630CE8537D38169248ED3DC6FB9F51CC626FB0EB524E7E9B86030464DBC1AD27403BA61E5B5594C98AEFC33DADA56495F33FDF6AF224E4E6C34A21D31E81BBB0853E468A320822F4D641558BCE6963799B61C1B775D9DDA3E3ABAAC30C6454169FA9ECF24995040B339805A61C025F1A94745B6F75E6520447A01D3131AD0DBE28FB59902D3870976D2FB694478338EABCAF4B00B1D269E154DA10F68D2334F8B84FA6AD5EDAACA1FA5A94B66573D61A633D6457DC7D5FCF0D146B064A07BCC68376C96B960E74EA026D00AC1261F16B7B582C36EFD73606BEBBB88F3F700071A30D4D5558723FA7EDCAC07C4B23A55C5FA8790BF5CEDFDD2739A97B05673B6673C9F7939E3E46DEEE4B7D9FAFA097B98ECF66E654711A64F8F8DACC2A2A3E6D5BEAEFB7C4950788E0A9E3F03A2549F6C6ECFDB7C970F68EAB8B875B218079702686E6C55FACF48240281CA808D76CEF31242458E6DC57EAD2F4FF6F8AF6A7DD9282A4BEE9493ECE757A89EC5112D831DC7E78026CFDCE8313DA0E531AF238D609B42DE299A397FF63FD2200E4B10D9A9CBCE4C5B8F9E94DC5E1261FB58CECF48F359654E99C4112B5FB378A05C050BA6B5B65660E2D2817AE2BAA5E84E1EF693D706610038C808FC85A9BFE5B0BF6CDA9C181319D7DDE0206588B041991224BFE65E4393A6CE9138FCA326B9FEEFE945A02040B2738A6A3FD24AC1CAC25C253AD5C205091B18E6F2381BC32EC305D8B900C4082633B21960885869CACD1F6C34BDFF122FA47CA428040DBC4CAC848DFB3DE7C8ED8F19B534B982884BCFC57C982B61A31E885C0708D3EB159433B81B9F368A2AAFC824CE56F7CFF7614D163A7B5D69EF25D6C7A662D6A58F9292336FB37595DF29F6AA4ADA538B012BA1866F795FED7815EE688F66B63FD103C74FD000ED04DB898EFAB39F24C28AD235E5C6C29485E53777821842DEBFD9FCD17E65438DE1FD80D6BD7A680F5092F1BD3D2C7E32AA34B5072E481DA2B461259B022CADC0CDA21CFF0ACE1D37D526D793ECD2DDE101752CDBDD30DB584F07C3F33C8E258C17B047453D4E06DE85AD0F2E6044D569C34C8A4BF2CE60B8C357DD33671BBC85F1FD7C427A4C435B9F7BF34FF4E5719130E21BAA4B7FE7AB139075A1D59DD6AAA62F3E10D261507AE39D15F7A00FF93D31BCC912EB628CD804B83059C53C53F09EF61D61C373339E34E1A2E7FBB3E7B26715927C55AECD153D9CEC3933B4B324ACD42D8A56CA0DC68565D7B99513E15DF6701C1842789C3F83315463F9F23B825D24CE9C38135E1C4F9BBA5C38E139274E87B1E16998402216AF7CA8C6E170E847A072C9EFA6E0B8D2782A8168343AC3E263420EBF6968B807DA7E15AE34D21E198EC58509927703E5AE45F5717955E318382FD305E04BE209C999207610B486509B0E20F336864C86D030505E83EAECAC4EC088D092434EC8B87DD94E597D426B66F6FC346EFDBD64A5E8E295A651A1E3BE28630D3405CBC6D08B49DBF8C28766D5EE42B1FC4F262AC3F5B9B60564D9C54205E3A4E9F74DB8F80E1DD7B519A50709EA226BFBACEEA9AA5638DD8A76FE8CA06CA3DC1DBB240FC7561A8F5470AFEDB84E6A12371D632174BB33F9C437B68EF10178F571A2A06CEB6BFE5853A5F849041EDFA7064FFB11D42AF7F3390B7D76E88491DA2C63BAF8BD1577E1C62E649FCC9433F3D521DFA4502444D7832793AC700E260382139A9EE359B9CBC872D40F2ED89AC34D5A1E5B2D72723FF90FA60D3581173A33CA02B541C558E12D49C4368AD9D440A53A5BAF92E4884AB9D810F49BAD138E4B53BD89B2D9DEBBC5E8A21";
            if (license == null) {
                Log.d(TAG, "obtainLicenses(): return NO_LICENSES_AVAILABLE");
                return GKLicenseValidationResult.NO_LICENSES_AVAILABLE;
            } else {
                Log.d(TAG, "obtainLicenses(): Validate license");
                return validateLicense(license);
            }
        } catch (IOException e1) {
            Log.e(TAG, e1.getMessage());
            return GKLicenseValidationResult.COMMUNICATION_ERROR;
        } catch (Exception e2) {
            Log.e(TAG, e2.getMessage());
            return GKLicenseValidationResult.ERROR;
        }
    }

    private String getLicense() throws IOException {
        Log.d(TAG, "getLicense(): validateLicense = " + mLicenseSubDir);
        String licenseSubDir = GKFileUtils.joinPath(GKFileUtils.LICENSE_ROOT, mLicenseSubDir);
        GKFile existingLicenseFile = getFirstFile(licenseSubDir, LicenseFileExtensions.LICENSE);
        // GKFile existingLicenseFile = getFile(licenseSubDir, LICENSE_FILE_NAME);
        if (existingLicenseFile != null) {
            return getFetchExistingLicense().execute(existingLicenseFile);
        }

        GKFile serialNumberFile = getFirstFile(GKFileUtils.LICENSE_ROOT, LicenseFileExtensions.SERIAL_NUMBER);
        // GKFile serialNumberFile = getFile(GKFileUtils.LICENSE_ROOT, LICENSE_SERIAL_FILE_NAME);
        if (serialNumberFile != null) {
            return getGenerateActiveLicense().execute(serialNumberFile);
        }

        return null;
    }

    private GKLicenseValidationResult validateLicense(String license) throws IOException {
        Log.d(TAG, "validateLicense(): license = \'" + license + "\'");

        mLicenseManager.add(license);

        for (String component : LICENSES) {
            Log.d(TAG, "validateLicense(): component = " + component);
            if (!mLicenseManager.obtainComponents(component)) {
                Log.d(TAG, "validateLicense(): return GKLicenseValidationResult.VALIDATION_FAILURE");
                return GKLicenseValidationResult.VALIDATION_FAILURE;
            }
        }
        Log.d(TAG, "validateLicense(): return GKLicenseValidationResult.SUCCESS");
        return GKLicenseValidationResult.SUCCESS;
    }

    private GKFile getFile(String dir, String filename) throws IOException {
        String path = GKFileUtils.joinPath(dir, filename);
        return new GKFile(path, GKFile.Type.FILE);
    }

    private GKFile getFirstFile(String dir, String extension) throws IOException {
        Log.d(TAG, "getFirstFile(): dir = " + dir + ", extension = " + extension);
        GKFileActions.ListFilesResult listFilesResult = mFileActions.listFiles(dir);

        for (GKFile file : listFilesResult.getFiles()) {
            if (extension.equals(file.getExtension())) {
                Log.d(TAG, "getFirstFile(): File match = " + file.getName());
                return file;
            }
        }
        Log.d(TAG, "getFirstFile(): No matching file, return null");
        return null;
    }

    private FetchExistingLicense getFetchExistingLicense() {
        Log.d(TAG, "getFetchExistingLicense()");
        if (mFetchExistingLicense == null) {
            Log.d(TAG, "mFetchExistingLicense = null.  Create new one");
            mFetchExistingLicense = new FetchExistingLicense(mFileActions);
        }
        return mFetchExistingLicense;
    }

    private GenerateActiveLicense getGenerateActiveLicense() {
        Log.d(TAG, "getGenerateActiveLicense()");
        if (mGenerateActiveLicense == null) {
            mGenerateActiveLicense = new GenerateActiveLicense(mLicenseManager, mFileActions, mLicenseSubDir);
        }
        return mGenerateActiveLicense;
    }

    private String parseLicenseSubDir(String licenseSubDir) {
        return licenseSubDir.replaceAll("[^A-Za-z0-9\\._-]", "_");
    }
}
